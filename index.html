<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PlaneaciÃ³n EstratÃ©gica - Sistema Completo</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#1F2937}.loading{display:flex;justify-content:center;align-items:center;height:100vh;color:white;font-size:1.5rem}.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem}.auth-box{background:white;border-radius:16px;padding:2rem;max-width:400px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.auth-header{text-align:center;margin-bottom:2rem}.auth-header h1{font-size:1.75rem;color:#4F46E5;margin-bottom:0.5rem}.form-group{margin-bottom:1.5rem}.form-group label{display:block;margin-bottom:0.5rem;font-weight:600;color:#374151}.form-group input,.form-group select,.form-group textarea{width:100%;padding:0.75rem;border:2px solid #E5E7EB;border-radius:8px;font-size:1rem}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#4F46E5}.btn-primary{width:100%;padding:0.875rem;border:none;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;margin-bottom:1rem}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(79,70,229,0.3)}.btn-primary:disabled{opacity:0.5;cursor:not-allowed}.btn-secondary{padding:0.75rem 1.5rem;border:2px solid #E5E7EB;background:white;color:#6B7280;border-radius:8px;font-weight:600;cursor:pointer;margin-right:0.5rem}.btn-secondary:hover{border-color:#4F46E5;color:#4F46E5}.btn-edit{padding:0.5rem 1rem;border:2px solid #4F46E5;background:white;color:#4F46E5;border-radius:6px;font-weight:600;cursor:pointer;font-size:0.875rem;margin-right:0.5rem}.btn-edit:hover{background:#4F46E5;color:white}.error-message{background:#FEE2E2;color:#991B1B;padding:0.75rem;border-radius:8px;margin-bottom:1rem;font-size:0.875rem}.app-container{display:flex;min-height:100vh}.sidebar{width:280px;background:rgba(255,255,255,0.95);display:flex;flex-direction:column;box-shadow:4px 0 24px rgba(0,0,0,0.08)}.sidebar-header{padding:2rem 1.5rem;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white}.sidebar-header h2{font-size:1.5rem;font-weight:700}.selector-entidad{padding:1rem 1.5rem;background:#F9FAFB;border-bottom:1px solid #E5E7EB}.selector-entidad select{width:100%;padding:0.5rem;border:2px solid #E5E7EB;border-radius:6px}.user-info{padding:1rem 1.5rem;background:#F9FAFB;border-bottom:1px solid #E5E7EB;font-size:0.875rem}.user-email{color:#4F46E5;font-weight:600;margin-bottom:0.5rem}.btn-logout{padding:0.5rem 1rem;background:white;border:2px solid #E5E7EB;border-radius:6px;cursor:pointer;font-size:0.875rem;width:100%}.nav-items{flex:1;padding:1rem 0}.nav-item{width:100%;padding:1rem 1.5rem;border:none;background:none;display:flex;align-items:center;gap:0.75rem;cursor:pointer;color:#4B5563;font-size:1rem;border-left:3px solid transparent;text-align:left}.nav-item:hover:not(:disabled){background:#F3F4F6;color:#4F46E5}.nav-item.activo{background:rgba(79,70,229,0.1);color:#4F46E5;font-weight:600;border-left-color:#4F46E5}.nav-item:disabled{opacity:0.4;cursor:not-allowed}.main-content{flex:1;padding:2rem;overflow-y:auto;background:#F9FAFB}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem}.page-header h1{font-size:2rem;font-weight:800;color:#111827}.card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:1.5rem}.card h3{font-size:1.25rem;font-weight:700;color:#111827;margin-bottom:1rem}.card h4{font-size:1.1rem;font-weight:600;color:#374151;margin-bottom:0.5rem}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem}.stat-card{background:white;border-radius:12px;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);border-left:4px solid #4F46E5}.stat-label{font-size:0.875rem;color:#6B7280;margin-bottom:0.5rem;text-transform:uppercase;font-weight:600}.stat-value{font-size:2.5rem;font-weight:800;color:#111827}.semaforo{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;border-radius:8px;font-size:0.875rem;font-weight:600}.semaforo.critico{background:#FEE2E2;color:#991B1B}.semaforo.precaucion{background:#FEF3C7;color:#92400E}.semaforo.optimo{background:#D1FAE5;color:#065F46}.tabla{width:100%;border-collapse:collapse}.tabla th{background:#F9FAFB;padding:1rem;text-align:left;font-weight:700;color:#374151;font-size:0.875rem}.tabla td{padding:1rem;border-top:1px solid #E5E7EB}.tabla tr:hover{background:#F9FAFB}.badge{display:inline-block;padding:0.25rem 0.75rem;border-radius:12px;font-size:0.75rem;font-weight:700}.empty-state{text-align:center;padding:4rem 2rem;color:#6B7280}.empty-state h3{font-size:1.5rem;color:#111827;margin:1rem 0}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.modal{background:white;border-radius:16px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}.modal-header{padding:1.5rem;border-bottom:1px solid #E5E7EB;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#4F46E5 0%,#7C3AED 100%);color:white;border-radius:16px 16px 0 0}.modal-header h2{font-size:1.5rem;font-weight:700}.btn-cerrar{background:rgba(255,255,255,0.2);border:none;color:white;width:36px;height:36px;border-radius:6px;cursor:pointer;font-size:1.5rem;line-height:1}.modal-body{padding:1.5rem}.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}.btn-group{display:flex;gap:0.5rem;margin-top:1rem;flex-wrap:wrap}@media print{.sidebar,.page-header button,.btn-primary,.btn-secondary,.btn-edit{display:none!important}.main-content{padding:1rem}.app-container{display:block}}@media(max-width:768px){.sidebar{width:100%}.app-container{flex-direction:column}.grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect}=React;
const firebaseConfig={apiKey:"AIzaSyAudtZnoZuRtbEDJ8Am-7XgDBDsqTTdU68",authDomain:"plan-estrategico-50ab9.firebaseapp.com",projectId:"plan-estrategico-50ab9",storageBucket:"plan-estrategico-50ab9.firebasestorage.app",messagingSenderId:"708927732803",appId:"1:708927732803:web:b55ff91c7649e93cf0e8f6"};
if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();
const imprimirInforme=()=>{window.print();};

const App=()=>{const[user,setUser]=useState(null);const[loading,setLoading]=useState(true);useEffect(()=>{const u=auth.onAuthStateChanged((u)=>{setUser(u);setLoading(false);});return()=>u();},[]);if(loading)return <div className="loading">â³ Cargando...</div>;if(!user)return <AuthScreen/>;return <MainApp user={user}/>;};

const AuthScreen=()=>{const[isLogin,setIsLogin]=useState(true);const[email,setEmail]=useState('');const[password,setPassword]=useState('');const[error,setError]=useState('');const[loading,setLoading]=useState(false);const handleSubmit=async(e)=>{e.preventDefault();setError('');setLoading(true);try{if(isLogin)await auth.signInWithEmailAndPassword(email,password);else await auth.createUserWithEmailAndPassword(email,password);}catch(err){setError(err.message);}finally{setLoading(false);}};return(<div className="auth-container"><div className="auth-box"><div className="auth-header"><h1>ğŸ¯ PlaneaciÃ³n EstratÃ©gica</h1><p>{isLogin?'Inicia sesiÃ³n':'Crea tu cuenta'}</p></div>{error&&<div className="error-message">âš ï¸ {error}</div>}<form onSubmit={handleSubmit}><div className="form-group"><label>Email</label><input type="email" value={email} onChange={(e)=>setEmail(e.target.value)} required/></div><div className="form-group"><label>ContraseÃ±a</label><input type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³':(isLogin?'ğŸ” Entrar':'ğŸ“ Crear Cuenta')}</button></form><div style={{textAlign:'center',fontSize:'0.875rem',color:'#6B7280'}}>{isLogin?'Â¿No tienes cuenta? ':'Â¿Ya tienes cuenta? '}<button onClick={()=>setIsLogin(!isLogin)} style={{background:'none',border:'none',color:'#4F46E5',fontWeight:600,cursor:'pointer',textDecoration:'underline'}}>{isLogin?'RegÃ­strate':'Inicia sesiÃ³n'}</button></div></div></div>);};

const MainApp=({user})=>{const[vista,setVista]=useState('entidades');const[entidades,setEntidades]=useState([]);const[entidadActiva,setEntidadActiva]=useState(null);const[datos,setDatos]=useState(null);useEffect(()=>{if(!user)return;const u=db.collection('usuarios').doc(user.uid).collection('entidades').onSnapshot((s)=>{const ents=[];s.forEach((doc)=>ents.push({id:doc.id,...doc.data()}));setEntidades(ents);if(entidadActiva){const act=ents.find(e=>e.id===entidadActiva.id);if(act)setEntidadActiva(act);}});return()=>u();},[user]);useEffect(()=>{if(!entidadActiva||!user){setDatos(null);return;}const ref=db.collection('usuarios').doc(user.uid).collection('entidades').doc(entidadActiva.id);const unsubs=[ref.collection('ejes').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,ejes:d}));}),ref.collection('objetivos').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,objetivos:d}));}),ref.collection('indicadores').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,indicadores:d}));}),ref.collection('seguimientos').onSnapshot(s=>{const d=[];s.forEach(doc=>d.push({id:doc.id,...doc.data()}));setDatos(p=>({...p,seguimientos:d}));})];return()=>unsubs.forEach(u=>u());},[entidadActiva,user]);return(<div className="app-container"><nav className="sidebar"><div className="sidebar-header"><h2>PlaneaciÃ³n EstratÃ©gica</h2><p style={{fontSize:'0.875rem',opacity:0.9}}>Multi-Entidad</p></div><div className="selector-entidad"><select value={entidadActiva?.id||''} onChange={(e)=>setEntidadActiva(entidades.find(en=>en.id===e.target.value)||null)}><option value="">Seleccionar...</option>{entidades.map(e=><option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div><div className="user-info"><div className="user-email">ğŸ‘¤ {user.email}</div><button className="btn-logout" onClick={()=>{if(window.confirm('Â¿Cerrar sesiÃ³n?'))auth.signOut();}}>ğŸšª Cerrar</button></div><div className="nav-items"><button className={`nav-item ${vista==='entidades'?'activo':''}`} onClick={()=>setVista('entidades')}>ğŸ¢ Entidades</button><button className={`nav-item ${vista==='dashboard'?'activo':''}`} onClick={()=>setVista('dashboard')} disabled={!entidadActiva}>ğŸ“Š Dashboard</button><button className={`nav-item ${vista==='config'?'activo':''}`} onClick={()=>setVista('config')} disabled={!entidadActiva}>âš™ï¸ ConfiguraciÃ³n</button><button className={`nav-item ${vista==='seguimiento'?'activo':''}`} onClick={()=>setVista('seguimiento')} disabled={!entidadActiva}>ğŸ“ Seguimiento</button></div></nav><main className="main-content">{vista==='entidades'&&<VistaEntidades user={user} entidades={entidades} entidadActiva={entidadActiva}/>}{vista==='dashboard'&&<VistaDashboard entidad={entidadActiva} datos={datos}/>}{vista==='config'&&<VistaConfig user={user} entidad={entidadActiva} datos={datos}/>}{vista==='seguimiento'&&<VistaSeguimiento user={user} entidad={entidadActiva} datos={datos}/>}</main></div>);};

const VistaEntidades=({user,entidades,entidadActiva})=>{const[modal,setModal]=useState(null);const[form,setForm]=useState({});const[itemEdit,setItemEdit]=useState(null);const[loading,setLoading]=useState(false);const guardar=async(e)=>{e.preventDefault();setLoading(true);try{const scoreConfig={critico:{min:0,max:parseFloat(form.criticoMax||60),color:'#DC2626',label:'CrÃ­tico'},precaucion:{min:parseFloat(form.precaucionMin||61),max:parseFloat(form.precaucionMax||85),color:'#F59E0B',label:'PrecauciÃ³n'},optimo:{min:parseFloat(form.optimoMin||86),max:100,color:'#059669',label:'Ã“ptimo'}};const data={nombre:form.nombre,nit:form.nit,periodo:form.periodo,vision:form.vision||'',scoreConfig};if(itemEdit){await db.collection('usuarios').doc(user.uid).collection('entidades').doc(itemEdit.id).update(data);}else{await db.collection('usuarios').doc(user.uid).collection('entidades').add({...data,createdAt:firebase.firestore.FieldValue.serverTimestamp()});}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const eliminar=async(id)=>{if(!window.confirm('Â¿Eliminar entidad y todos sus datos?'))return;try{await db.collection('usuarios').doc(user.uid).collection('entidades').doc(id).delete();}catch(error){alert('Error: '+error.message);}};const editarEntidad=(ent)=>{setItemEdit(ent);setForm({nombre:ent.nombre,nit:ent.nit,periodo:ent.periodo,vision:ent.vision||'',criticoMax:ent.scoreConfig?.critico?.max||60,precaucionMin:ent.scoreConfig?.precaucion?.min||61,precaucionMax:ent.scoreConfig?.precaucion?.max||85,optimoMin:ent.scoreConfig?.optimo?.min||86});setModal('entidad');};return(<div><div className="page-header"><h1>Mis Entidades</h1><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({nombre:'',nit:'',periodo:'',vision:'',criticoMax:'60',precaucionMin:'61',precaucionMax:'85',optimoMin:'86'});setModal('entidad');}}>+ Nueva Entidad</button></div><div className="grid">{entidades.length===0?(<div className="empty-state"><h3>ğŸ¢ No hay entidades</h3><p>Crea tu primera entidad</p></div>):(entidades.map(ent=>(<div key={ent.id} className="card" style={{borderLeft:entidadActiva?.id===ent.id?'4px solid #4F46E5':'4px solid transparent'}}><h3>{ent.nombre}</h3><p style={{color:'#6B7280',marginBottom:'0.5rem'}}>NIT: {ent.nit}</p><div className="badge" style={{background:'#4F46E5',color:'white',marginBottom:'0.5rem'}}>{ent.periodo}</div>{ent.vision&&<p style={{color:'#4F46E5',fontSize:'0.875rem',marginBottom:'0.5rem'}}>ğŸ¯ {ent.vision}</p>}{ent.scoreConfig&&(<p style={{color:'#059669',fontSize:'0.75rem',marginTop:'0.5rem'}}>Score: 0-{ent.scoreConfig.critico.max}% ğŸ”´ | {ent.scoreConfig.precaucion.min}-{ent.scoreConfig.precaucion.max}% ğŸŸ¡ | {ent.scoreConfig.optimo.min}%+ ğŸŸ¢</p>)}<div className="btn-group"><button className="btn-edit" onClick={()=>editarEntidad(ent)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar(ent.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>)))}</div>{modal==='entidad'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nueva'} Entidad</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardar}><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-group"><label>NIT *</label><input type="text" value={form.nit} onChange={e=>setForm({...form,nit:e.target.value})} required/></div><div className="form-group"><label>Periodo *</label><input type="text" value={form.periodo} onChange={e=>setForm({...form,periodo:e.target.value})} required placeholder="2025-2027"/></div><div className="form-group"><label>VisiÃ³n</label><textarea value={form.vision} onChange={e=>setForm({...form,vision:e.target.value})} rows={3}/></div><div className="card" style={{background:'#FEF3C7',marginBottom:'1rem'}}><h4 style={{color:'#92400E',marginBottom:'0.5rem'}}>âš™ï¸ ConfiguraciÃ³n de Score (Global)</h4><div className="form-row"><div className="form-group"><label>ğŸ”´ CrÃ­tico: 0% hasta</label><input type="number" value={form.criticoMax} onChange={e=>setForm({...form,criticoMax:e.target.value})} required/></div><div className="form-group"><label>ğŸŸ¡ PrecauciÃ³n: desde</label><input type="number" value={form.precaucionMin} onChange={e=>setForm({...form,precaucionMin:e.target.value})} required/></div></div><div className="form-row"><div className="form-group"><label>ğŸŸ¡ PrecauciÃ³n: hasta</label><input type="number" value={form.precaucionMax} onChange={e=>setForm({...form,precaucionMax:e.target.value})} required/></div><div className="form-group"><label>ğŸŸ¢ Ã“ptimo: desde</label><input type="number" value={form.optimoMin} onChange={e=>setForm({...form,optimoMin:e.target.value})} required/></div></div><small style={{color:'#92400E'}}>Este score se aplicarÃ¡ a TODOS los indicadores de esta entidad</small></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³ Guardando...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};

const VistaDashboard=({entidad,datos})=>{if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;const{ejes=[],objetivos=[],indicadores=[],seguimientos=[]}=datos;const periodos=[...new Set(seguimientos.map(s=>`${s.mes} ${s.anio}`))].sort((a,b)=>{const[mesA,anioA]=a.split(' ');const[mesB,anioB]=b.split(' ');const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];if(anioA!==anioB)return parseInt(anioA)-parseInt(anioB);return meses.indexOf(mesA)-meses.indexOf(mesB);});const ultimoPeriodo=periodos[periodos.length-1];const seguimientosUltimo=seguimientos.filter(s=>`${s.mes} ${s.anio}`===ultimoPeriodo);const porScore={critico:0,precaucion:0,optimo:0};seguimientosUltimo.forEach(s=>{if(s.score)porScore[s.score]++;});const indicadoresConEstado=indicadores.map(ind=>{const ultSeg=seguimientos.filter(s=>s.indicadorId===ind.id).sort((a,b)=>{const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];if(a.anio!==b.anio)return parseInt(b.anio)-parseInt(a.anio);return meses.indexOf(b.mes)-meses.indexOf(a.mes);})[0];const obj=objetivos.find(o=>o.id===ind.objetivoId);const eje=ejes.find(e=>e.id===obj?.ejeId);return{...ind,ultimoSeguimiento:ultSeg,objetivo:obj,eje:eje};});return(<div><div className="page-header"><div><h1>Dashboard - {entidad.nombre}</h1><p style={{color:'#6B7280'}}>{entidad.periodo}</p></div><button className="btn-primary" style={{width:'auto'}} onClick={imprimirInforme}>ğŸ–¨ï¸ Imprimir</button></div><div className="grid"><div className="stat-card"><div className="stat-label">Ejes</div><div className="stat-value">{ejes.length}</div></div><div className="stat-card"><div className="stat-label">Indicadores</div><div className="stat-value">{indicadores.length}</div></div><div className="stat-card" style={{borderLeftColor:'#059669'}}><div className="stat-label">Ã“ptimos</div><div className="stat-value">{porScore.optimo}</div></div><div className="stat-card" style={{borderLeftColor:'#F59E0B'}}><div className="stat-label">PrecauciÃ³n</div><div className="stat-value">{porScore.precaucion}</div></div><div className="stat-card" style={{borderLeftColor:'#DC2626'}}><div className="stat-label">CrÃ­ticos</div><div className="stat-value">{porScore.critico}</div></div></div>{indicadoresConEstado.length>0&&(<div className="card"><h3>ğŸ“Š Estado de Indicadores ({ultimoPeriodo||'Sin datos'})</h3><table className="tabla"><thead><tr><th>Eje</th><th>Indicador</th><th>Meta</th><th>Avance</th><th>Rendimiento</th><th>Estado</th></tr></thead><tbody>{indicadoresConEstado.map(ind=>(<tr key={ind.id}><td><div className="badge" style={{background:ind.eje?.color||'#6B7280',color:'white'}}>{ind.eje?.nombre||'-'}</div></td><td><strong>{ind.nombre}</strong></td><td>{ind.ultimoSeguimiento?`${ind.ultimoSeguimiento.metaAnual||ind.meta} ${ind.unidad}`:'-'}</td><td>{ind.ultimoSeguimiento?`${ind.ultimoSeguimiento.avance} ${ind.unidad}`:'-'}</td><td>{ind.ultimoSeguimiento?<strong>{ind.ultimoSeguimiento.rendimiento.toFixed(2)}%</strong>:'-'}</td><td>{ind.ultimoSeguimiento?<div className={`semaforo ${ind.ultimoSeguimiento.score}`}>{ind.ultimoSeguimiento.score==='critico'&&'ğŸ”´'}{ind.ultimoSeguimiento.score==='precaucion'&&'ğŸŸ¡'}{ind.ultimoSeguimiento.score==='optimo'&&'ğŸŸ¢'}</div>:'-'}</td></tr>))}</tbody></table></div>)}</div>);};

const VistaConfig=({user,entidad,datos})=>{const[modal,setModal]=useState(null);const[form,setForm]=useState({});const[itemEdit,setItemEdit]=useState(null);const[loading,setLoading]=useState(false);if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona una entidad</h3></div>;const{ejes=[],objetivos=[],indicadores=[]}=datos;const ref=db.collection('usuarios').doc(user.uid).collection('entidades').doc(entidad.id);const scoreConfig=entidad.scoreConfig||{critico:{min:0,max:60},precaucion:{min:61,max:85},optimo:{min:86,max:100}};const guardarEje=async(e)=>{e.preventDefault();setLoading(true);try{if(itemEdit){await ref.collection('ejes').doc(itemEdit.id).update(form);}else{await ref.collection('ejes').add(form);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const guardarObjetivo=async(e)=>{e.preventDefault();setLoading(true);try{if(itemEdit){await ref.collection('objetivos').doc(itemEdit.id).update(form);}else{await ref.collection('objetivos').add(form);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const guardarIndicador=async(e)=>{e.preventDefault();setLoading(true);try{const metasPorAnio={};if(form.anios){form.anios.split(',').forEach(a=>{const anio=a.trim();if(anio)metasPorAnio[anio]=parseFloat(form[`meta_${anio}`]||form.meta);});}const data={objetivoId:form.objetivoId,nombre:form.nombre,tipo:form.tipo,periodicidad:form.periodicidad,meta:parseFloat(form.meta),unidad:form.unidad,estrategia:form.estrategia||'',metasPorAnio};if(itemEdit){await ref.collection('indicadores').doc(itemEdit.id).update(data);}else{await ref.collection('indicadores').add(data);}setModal(null);setForm({});setItemEdit(null);}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const eliminar=async(coleccion,id)=>{if(!window.confirm('Â¿Eliminar?'))return;try{await ref.collection(coleccion).doc(id).delete();}catch(error){alert('Error: '+error.message);}};const editarEje=(eje)=>{setItemEdit(eje);setForm({nombre:eje.nombre,color:eje.color});setModal('eje');};const editarObjetivo=(obj)=>{setItemEdit(obj);setForm({ejeId:obj.ejeId,nombre:obj.nombre});setModal('objetivo');};const editarIndicador=(ind)=>{setItemEdit(ind);const anios=ind.metasPorAnio?Object.keys(ind.metasPorAnio).join(','):'';const formData={objetivoId:ind.objetivoId,nombre:ind.nombre,tipo:ind.tipo,periodicidad:ind.periodicidad,meta:ind.meta,unidad:ind.unidad,estrategia:ind.estrategia||'',anios};if(ind.metasPorAnio){Object.entries(ind.metasPorAnio).forEach(([anio,meta])=>{formData[`meta_${anio}`]=meta;});}setForm(formData);setModal('indicador');};return(<div><div className="page-header"><h1>ConfiguraciÃ³n - {entidad.nombre}</h1></div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Ejes EstratÃ©gicos ({ejes.length})</h3><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({nombre:'',color:'#4F46E5'});setModal('eje');}}>+ Nuevo Eje</button></div>{ejes.length===0?<p style={{color:'#6B7280'}}>No hay ejes</p>:<div className="grid">{ejes.map(eje=>(<div key={eje.id} className="card" style={{borderLeft:`4px solid ${eje.color}`}}><h4>{eje.nombre}</h4><div className="btn-group"><button className="btn-edit" onClick={()=>editarEje(eje)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('ejes',eje.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>))}</div>}</div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Objetivos ({objetivos.length})</h3><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({ejeId:'',nombre:''});setModal('objetivo');}} disabled={ejes.length===0}>+ Nuevo Objetivo</button></div>{objetivos.length===0?<p style={{color:'#6B7280'}}>No hay objetivos</p>:objetivos.map(obj=>{const eje=ejes.find(e=>e.id===obj.ejeId);return(<div key={obj.id} className="card" style={{borderLeft:`4px solid ${eje?.color||'#6B7280'}`}}><div className="badge" style={{background:eje?.color,color:'white',marginBottom:'0.5rem'}}>{eje?.nombre||'Sin eje'}</div><p>{obj.nombre}</p><div className="btn-group"><button className="btn-edit" onClick={()=>editarObjetivo(obj)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('objetivos',obj.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>);})}</div><div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1rem'}}><h3>Indicadores ({indicadores.length})</h3><button className="btn-primary" style={{width:'auto'}} onClick={()=>{setItemEdit(null);setForm({objetivoId:'',nombre:'',tipo:'ascendente',periodicidad:'Mensual',meta:'',unidad:'%',estrategia:'',anios:''});setModal('indicador');}} disabled={objetivos.length===0}>+ Nuevo Indicador</button></div>{indicadores.length===0?<p style={{color:'#6B7280'}}>No hay indicadores</p>:<div className="grid">{indicadores.map(ind=>{const obj=objetivos.find(o=>o.id===ind.objetivoId);const eje=ejes.find(e=>e.id===obj?.ejeId);return(<div key={ind.id} className="card" style={{borderLeft:`4px solid ${eje?.color||'#6B7280'}`}}><div className="badge" style={{background:eje?.color,color:'white',marginBottom:'0.5rem'}}>{eje?.nombre}</div><h4>{ind.nombre}</h4><p style={{color:'#6B7280',fontSize:'0.875rem',marginTop:'0.5rem'}}>Meta: {ind.meta} {ind.unidad} | {ind.tipo==='ascendente'?'ğŸ“ˆ':'ğŸ“‰'}</p>{ind.metasPorAnio&&Object.keys(ind.metasPorAnio).length>0&&(<p style={{color:'#4F46E5',fontSize:'0.75rem',marginTop:'0.25rem'}}>Metas: {Object.entries(ind.metasPorAnio).map(([a,m])=>`${a}:${m}`).join(', ')}</p>)}<div className="btn-group"><button className="btn-edit" onClick={()=>editarIndicador(ind)}>âœï¸ Editar</button><button className="btn-secondary" onClick={()=>eliminar('indicadores',ind.id)}>ğŸ—‘ï¸ Eliminar</button></div></div>);})}</div>}</div>{modal==='eje'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Eje</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarEje}><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-group"><label>Color</label><input type="color" value={form.color} onChange={e=>setForm({...form,color:e.target.value})}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}{modal==='objetivo'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Objetivo</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarObjetivo}><div className="form-group"><label>Eje *</label><select value={form.ejeId} onChange={e=>setForm({...form,ejeId:e.target.value})} required><option value="">Seleccionar...</option>{ejes.map(e=><option key={e.id} value={e.id}>{e.nombre}</option>)}</select></div><div className="form-group"><label>Nombre *</label><textarea value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required rows={3}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}{modal==='indicador'&&(<div className="modal-overlay" onClick={()=>setModal(null)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>{itemEdit?'Editar':'Nuevo'} Indicador</h2><button className="btn-cerrar" onClick={()=>setModal(null)}>Ã—</button></div><div className="modal-body"><form onSubmit={guardarIndicador}><div className="form-group"><label>Objetivo *</label><select value={form.objetivoId} onChange={e=>setForm({...form,objetivoId:e.target.value})} required><option value="">Seleccionar...</option>{objetivos.map(obj=>{const eje=ejes.find(e=>e.id===obj.ejeId);return<option key={obj.id} value={obj.id}>[{eje?.nombre}] {obj.nombre}</option>;})}</select></div><div className="form-group"><label>Nombre *</label><input type="text" value={form.nombre} onChange={e=>setForm({...form,nombre:e.target.value})} required/></div><div className="form-row"><div className="form-group"><label>Tipo *</label><select value={form.tipo} onChange={e=>setForm({...form,tipo:e.target.value})} required><option value="ascendente">ğŸ“ˆ Ascendente</option><option value="descendente">ğŸ“‰ Descendente</option></select></div><div className="form-group"><label>Periodicidad *</label><select value={form.periodicidad} onChange={e=>setForm({...form,periodicidad:e.target.value})} required><option value="Mensual">Mensual</option><option value="Bimestral">Bimestral</option><option value="Trimestral">Trimestral</option></select></div></div><div className="form-row"><div className="form-group"><label>Meta Base *</label><input type="number" step="0.01" value={form.meta} onChange={e=>setForm({...form,meta:e.target.value})} required/></div><div className="form-group"><label>Unidad *</label><input type="text" value={form.unidad} onChange={e=>setForm({...form,unidad:e.target.value})} required placeholder="%"/></div></div><div className="form-group"><label>AÃ±os con Metas EspecÃ­ficas</label><input type="text" value={form.anios} onChange={e=>setForm({...form,anios:e.target.value})} placeholder="2025,2026,2027"/><small style={{color:'#6B7280',display:'block',marginTop:'0.25rem'}}>Separados por coma</small></div>{form.anios&&form.anios.split(',').map(a=>{const anio=a.trim();if(!anio)return null;return(<div key={anio} className="form-group"><label>Meta para {anio}</label><input type="number" step="0.01" value={form[`meta_${anio}`]||form.meta} onChange={e=>setForm({...form,[`meta_${anio}`]:e.target.value})}/></div>);})}<div className="form-group"><label>Estrategia</label><textarea value={form.estrategia} onChange={e=>setForm({...form,estrategia:e.target.value})} rows={3}/></div><button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};

const VistaSeguimiento=({user,entidad,datos})=>{const[indicadorSel,setIndicadorSel]=useState(null);const[modal,setModal]=useState(false);const[form,setForm]=useState({});const[loading,setLoading]=useState(false);if(!entidad||!datos)return <div className="empty-state"><h3>Selecciona entidad</h3></div>;const{ejes=[],objetivos=[],indicadores=[],seguimientos=[]}=datos;const ref=db.collection('usuarios').doc(user.uid).collection('entidades').doc(entidad.id);const scoreConfig=entidad.scoreConfig||{critico:{min:0,max:60},precaucion:{min:61,max:85},optimo:{min:86,max:100}};const calcularRendimiento=(ind,avance,metaUsada)=>{const meta=metaUsada||ind.meta;if(ind.tipo==='ascendente'){return((avance/meta)*100).toFixed(2);}else{if(avance<=meta){return(((meta-avance)/meta)*100+100).toFixed(2);}else{return((meta/avance)*100).toFixed(2);}}};const determinarScore=(rendimiento)=>{const rend=parseFloat(rendimiento);if(rend>=scoreConfig.optimo.min)return'optimo';if(rend>=scoreConfig.precaucion.min)return'precaucion';return'critico';};const guardar=async(e)=>{e.preventDefault();setLoading(true);try{const ind=indicadores.find(i=>i.id===indicadorSel);const anio=parseInt(form.anio);const metaAnual=ind.metasPorAnio&&ind.metasPorAnio[anio]?ind.metasPorAnio[anio]:ind.meta;const avance=parseFloat(form.avance);const rendimiento=parseFloat(calcularRendimiento(ind,avance,metaAnual));const score=determinarScore(rendimiento);await ref.collection('seguimientos').add({indicadorId:indicadorSel,mes:form.mes,anio:anio,metaAnual:metaAnual,metaMes:parseFloat(form.metaMes),avance,rendimiento,score,createdAt:firebase.firestore.FieldValue.serverTimestamp()});setModal(false);setForm({});}catch(error){alert('Error: '+error.message);}finally{setLoading(false);}};const indicador=indicadores.find(i=>i.id===indicadorSel);const seguimientosInd=seguimientos.filter(s=>s.indicadorId===indicadorSel).sort((a,b)=>{const meses=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];if(a.anio!==b.anio)return a.anio-b.anio;return meses.indexOf(a.mes)-meses.indexOf(b.mes);});return(<div><div className="page-header"><h1>Seguimiento Mensual</h1><button className="btn-primary" style={{width:'auto'}} onClick={()=>{if(!indicadorSel){alert('Selecciona indicador primero');return;}setModal(true);setForm({mes:'',anio:new Date().getFullYear().toString(),metaMes:'',avance:''});}}>+ Registrar Avance</button></div><div className="card"><div className="form-group"><label>Seleccionar Indicador</label><select value={indicadorSel||''} onChange={e=>setIndicadorSel(e.target.value||null)}><option value="">Seleccionar...</option>{indicadores.map(ind=>{const obj=objetivos.find(o=>o.id===ind.objetivoId);const eje=ejes.find(e=>e.id===obj?.ejeId);return<option key={ind.id} value={ind.id}>[{eje?.nombre}] {ind.nombre}</option>;})}</select></div></div>{indicador&&(<><div className="card"><h3>{indicador.nombre}</h3><p style={{color:'#6B7280',marginTop:'0.5rem'}}>Meta base: <strong>{indicador.meta} {indicador.unidad}</strong> | {indicador.tipo==='ascendente'?'ğŸ“ˆ':'ğŸ“‰'}</p>{indicador.metasPorAnio&&Object.keys(indicador.metasPorAnio).length>0&&(<p style={{color:'#4F46E5',marginTop:'0.5rem'}}>ğŸ“… Metas: {Object.entries(indicador.metasPorAnio).map(([a,m])=>`${a}: ${m} ${indicador.unidad}`).join(' | ')}</p>)}{indicador.estrategia&&<p style={{color:'#4F46E5',marginTop:'1rem'}}>ğŸ¯ {indicador.estrategia}</p>}</div>{seguimientosInd.length===0?(<div className="empty-state"><h3>No hay seguimientos</h3></div>):(<div className="card"><h3>HistÃ³rico</h3><button className="btn-secondary" style={{marginBottom:'1rem'}} onClick={imprimirInforme}>ğŸ–¨ï¸ Imprimir</button><table className="tabla"><thead><tr><th>Periodo</th><th>Meta Anual</th><th>Meta Mes</th><th>Avance</th><th>Rendimiento</th><th>Estado</th></tr></thead><tbody>{seguimientosInd.map(seg=>(<tr key={seg.id}><td><strong>{seg.mes} {seg.anio}</strong></td><td>{seg.metaAnual||indicador.meta} {indicador.unidad}</td><td>{seg.metaMes} {indicador.unidad}</td><td>{seg.avance} {indicador.unidad}</td><td><strong>{seg.rendimiento.toFixed(2)}%</strong></td><td><div className={`semaforo ${seg.score}`}>{seg.score==='critico'&&'ğŸ”´'}{seg.score==='precaucion'&&'ğŸŸ¡'}{seg.score==='optimo'&&'ğŸŸ¢'}</div></td></tr>))}</tbody></table></div>)}</>)}{modal&&indicador&&(<div className="modal-overlay" onClick={()=>setModal(false)}><div className="modal" onClick={e=>e.stopPropagation()}><div className="modal-header"><h2>Registrar Seguimiento</h2><button className="btn-cerrar" onClick={()=>setModal(false)}>Ã—</button></div><div className="modal-body"><div style={{background:'#EEF2FF',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}><h4 style={{color:'#4F46E5'}}>{indicador.nombre}</h4><p style={{color:'#6B7280',fontSize:'0.875rem'}}>Meta base: {indicador.meta} {indicador.unidad}</p>{form.anio&&indicador.metasPorAnio&&indicador.metasPorAnio[form.anio]&&(<p style={{color:'#059669',fontSize:'0.875rem',fontWeight:'bold'}}>Meta {form.anio}: {indicador.metasPorAnio[form.anio]} {indicador.unidad}</p>)}</div><form onSubmit={guardar}><div className="form-row"><div className="form-group"><label>Mes *</label><select value={form.mes} onChange={e=>setForm({...form,mes:e.target.value})} required><option value="">Seleccionar...</option>{['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'].map(m=><option key={m} value={m}>{m}</option>)}</select></div><div className="form-group"><label>AÃ±o *</label><input type="number" value={form.anio} onChange={e=>setForm({...form,anio:e.target.value})} required min="2020" max="2030"/></div></div><div className="form-group"><label>Meta del Mes *</label><input type="number" step="0.01" value={form.metaMes} onChange={e=>setForm({...form,metaMes:e.target.value})} required/></div><div className="form-group"><label>Avance Real *</label><input type="number" step="0.01" value={form.avance} onChange={e=>setForm({...form,avance:e.target.value})} required/></div>{form.avance&&form.anio&&(<div style={{background:'#D1FAE5',padding:'1rem',borderRadius:'8px',marginBottom:'1rem'}}><h4 style={{color:'#065F46'}}>Vista Previa</h4><p style={{color:'#065F46',margin:'0.5rem 0'}}>Meta usada: <strong>{(indicador.metasPorAnio&&indicador.metasPorAnio[form.anio])||indicador.meta} {indicador.unidad}</strong></p><p style={{color:'#065F46',margin:'0.5rem 0'}}>Rendimiento: <strong>{calcularRendimiento(indicador,parseFloat(form.avance),(indicador.metasPorAnio&&indicador.metasPorAnio[form.anio])||indicador.meta)}%</strong></p><div className={`semaforo ${determinarScore(calcularRendimiento(indicador,parseFloat(form.avance),(indicador.metasPorAnio&&indicador.metasPorAnio[form.anio])||indicador.meta))}`}>{determinarScore(calcularRendimiento(indicador,parseFloat(form.avance),(indicador.metasPorAnio&&indicador.metasPorAnio[form.anio])||indicador.meta))==='critico'&&'ğŸ”´ CrÃ­tico'}{determinarScore(calcularRendimiento(indicador,parseFloat(form.avance),(indicador.metasPorAnio&&indicador.metasPorAnio[form.anio])||indicador.meta))==='precaucion'&&'ğŸŸ¡ PrecauciÃ³n'}{determinarScore(calcularRendimiento(indicador,parseFloat(form.avance),(indicador.metasPorAnio&&indicador.metasPorAnio[form.anio])||indicador.meta))==='optimo'&&'ğŸŸ¢ Ã“ptimo'}</div></div>)}<button type="submit" className="btn-primary" disabled={loading}>{loading?'â³...':'ğŸ’¾ Guardar'}</button></form></div></div></div>)}</div>);};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
